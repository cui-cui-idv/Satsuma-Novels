<%- include('partials/header') %>

<main class="container">
    <div class="card" style="text-align: center;">
        <h2>メールアドレスの確認が必要です</h2>
        <p style="color: var(--font-secondary); margin-top: 1.5rem;">
            ご登録ありがとうございます。<br>
            アカウントを有効にするため、<strong><%= user.email %></strong> 宛に送信された確認メール内のリンクをクリックしてください。
        </p>
        <p style="color: var(--font-secondary); font-size: 0.9rem;">
            （メールが届かない場合は、迷惑メールフォルダもご確認ください）
        </p>

        <div style="margin-top: 2rem;">
            <button id="resend-email-button" class="btn btn-primary">確認メールを再送信</button>
        </div>
        <p id="message" style="margin-top: 1rem;"></p>
    </div>
</main>

<%- include('partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const auth = firebase.auth();
    const resendButton = document.getElementById('resend-email-button');
    const messageEl = document.getElementById('message');

    auth.onAuthStateChanged(user => {
        if (user) {
            let cooldown = false;
            resendButton.addEventListener('click', () => {
                if (cooldown) return;
                messageEl.textContent = '送信中です...';
                
                // ▼▼▼ ここが重要 ▼▼▼
                const actionCodeSettings = {
                    url: `${window.location.origin}/verify-email-action`,
                    handleCodeInApp: true
                };
                user.sendEmailVerification(actionCodeSettings)
                    .then(() => {
                        messageEl.style.color = 'var(--accent-primary)';
                        messageEl.textContent = '確認メールを再送信しました。';
                        cooldown = true;
                        resendButton.disabled = true;
                        let seconds = 60;
                        resendButton.textContent = `再送信 (${seconds})`;
                        const interval = setInterval(() => {
                            seconds--;
                            resendButton.textContent = `再送信 (${seconds})`;
                            if (seconds <= 0) {
                                clearInterval(interval);
                                resendButton.textContent = '確認メールを再送信';
                                resendButton.disabled = false;
                                cooldown = false;
                            }
                        }, 1000);
                    }).catch(error => {
                        console.error('メール再送信エラー:', error);
                        messageEl.style.color = '#ff4d4d';
                        messageEl.textContent = 'エラーが発生しました。時間をおいて再試行してください。';
                    });
            });
        } else {
            resendButton.disabled = true;
        }
    });
});
</script>