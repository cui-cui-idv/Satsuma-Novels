<%- include('partials/header') %>

<main class="container">
    <h2>アカウント設定</h2>

    <div class="card" style="margin-top: 2rem;">
        <h3 class="card-title">メールアドレスの変更</h3>
        <form id="update-email-form" class="auth-form-wrapper" style="margin: 0; max-width: none; background: none; border: none; padding: 0;">
            <div class="input-group">
                <label for="new-email">新しいメールアドレス</label>
                <input type="email" id="new-email" required>
            </div>
            <div class="input-group">
                <label for="current-password-for-email">現在のパスワード（確認用）</label>
                <input type="password" id="current-password-for-email" required>
            </div>
            <button type="submit" class="btn btn-primary">メールアドレスを更新</button>
            <p id="email-message" style="margin-top: 1rem; text-align: center;"></p>
        </form>
    </div>

    <div class="card" style="margin-top: 2rem;">
        <h3 class="card-title">パスワードの変更</h3>
        <form id="update-password-form" class="auth-form-wrapper" style="margin: 0; max-width: none; background: none; border: none; padding: 0;">
            <div class="input-group">
                <label for="current-password">現在のパスワード</label>
                <input type="password" id="current-password" required>
            </div>
            <div class="input-group">
                <label for="new-password">新しいパスワード</label>
                <input type="password" id="new-password" minlength="6" required>
            </div>
            <button type="submit" class="btn btn-primary">パスワードを更新</button>
            <p id="password-message" style="margin-top: 1rem; text-align: center;"></p>
        </form>
    </div>
</main>

<%- include('partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const auth = firebase.auth();

    // ▼▼▼ 認証状態が変わるのを監視するリスナーを登録 ▼▼▼
    auth.onAuthStateChanged(user => {
        

        if (user) {
            // --- ユーザーがログインしている場合の処理 ---
            const emailForm = document.getElementById('update-email-form');
            const passwordForm = document.getElementById('update-password-form');
            const emailMessage = document.getElementById('email-message');
            const passwordMessage = document.getElementById('password-message');

            // メールアドレス変更処理
            emailForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                emailMessage.textContent = '処理中...';
                emailMessage.style.color = 'var(--font-secondary)';
                
                const newEmail = document.getElementById('new-email').value;
                const password = document.getElementById('current-password-for-email').value;

                try {
                    const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                    await user.reauthenticateWithCredential(credential);
                    await user.updateEmail(newEmail);
                    await fetch('/account/update-email', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ newEmail: newEmail })
                    });

                    emailMessage.style.color = 'var(--accent-primary)';
                    emailMessage.textContent = 'メールアドレスが正常に更新されました。ページをリロードします。';
                    setTimeout(() => location.reload(), 2000);
                } catch (error) {
                    console.error("メール更新エラー:", error);
                    emailMessage.style.color = '#ff4d4d';
                    emailMessage.textContent = 'エラー: ' + error.message;
                }
            });

            // パスワード変更処理
            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                passwordMessage.textContent = '処理中...';
                passwordMessage.style.color = 'var(--font-secondary)';

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                
                try {
                    const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                    await user.reauthenticateWithCredential(credential);
                    await user.updatePassword(newPassword);
                    
                    passwordMessage.style.color = 'var(--accent-primary)';
                    passwordMessage.textContent = 'パスワードが正常に更新されました。';
                    passwordForm.reset();
                } catch (error) {
                    console.error("パスワード更新エラー:", error);
                    passwordMessage.style.color = '#ff4d4d';
                    passwordMessage.textContent = 'エラー: ' + error.message;
                }
            });
            
        } else {
            // --- ユーザーがログインしていない場合の処理 ---
            console.error('ユーザーがログインしていません。フォームを無効化します。');
            // 必要に応じて、フォームを非表示にしたり、ログインページへのリンクを表示したりする
            const forms = document.querySelectorAll('form');
            forms.forEach(form => form.style.display = 'none');
            document.querySelector('.container').innerHTML += '<p style="text-align: center;">この機能を利用するには、ログインが必要です。</p>';
        }
    });
});
</script>