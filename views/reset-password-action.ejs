<%- include('partials/header') %>
<div class="auth-container">
    <div class="auth-form-wrapper" id="reset-form-wrapper">
        <h2>新しいパスワードを設定</h2>
        <form id="reset-password-form">
            <div class="input-group">
                <input type="password" id="new-password" required placeholder="新しいパスワード">
            </div>
            <button type="submit" class="btn btn-primary">パスワードを更新</button>
        </form>
        <p id="message" style="text-align: center; margin-top: 1rem;"></p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const resetForm = document.getElementById('reset-password-form');
        const newPasswordInput = document.getElementById('new-password');
        const messageEl = document.getElementById('message');
        const formWrapper = document.getElementById('reset-form-wrapper');

        // URLからクエリパラメータを取得
        const urlParams = new URLSearchParams(window.location.search);
        const actionCode = urlParams.get('oobCode');

        if (!actionCode) {
            messageEl.style.color = '#ff4d4d';
            messageEl.textContent = '無効なリンクです。';
            resetForm.style.display = 'none';
            return;
        }

        // パスワードリセットコードを検証
        firebase.auth().verifyPasswordResetCode(actionCode)
            .then(email => {
                // コードが有効な場合の処理
                messageEl.style.color = 'var(--font-secondary)';
                messageEl.textContent = `アカウント (${email}) の新しいパスワードを設定してください。`;
            })
            .catch(error => {
                // コードが無効な場合の処理
                messageEl.style.color = '#ff4d4d';
                messageEl.textContent = '無効または期限切れのリンクです。もう一度パスワードリセットを要求してください。';
                resetForm.style.display = 'none';
            });
        
        // フォームが送信されたときの処理
        resetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newPassword = newPasswordInput.value;

            // 新しいパスワードで更新
            firebase.auth().confirmPasswordReset(actionCode, newPassword)
                .then(() => {
                    formWrapper.innerHTML = `
                        <h2>パスワードが更新されました</h2>
                        <p style="color: var(--font-secondary); text-align: center;">新しいパスワードでログインしてください。</p>
                        <a href="/login" class="btn btn-primary" style="margin-top: 2rem;">ログインページへ</a>
                    `;
                })
                .catch(error => {
                    messageEl.style.color = '#ff4d4d';
                    messageEl.textContent = 'エラーが発生しました: ' + error.message;
                });
        });
    });
</script>

<%- include('partials/footer') %>